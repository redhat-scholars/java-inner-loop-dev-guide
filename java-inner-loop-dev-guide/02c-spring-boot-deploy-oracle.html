<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Oracle as Database :: Java Inner Loop Dev Guide</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide/java-inner-loop-dev-guide/02c-spring-boot-deploy-oracle.html">
    <link rel="prev" href="02b-spring-boot-deploy-postgresql.html">
    <link rel="next" href="03a-quarkus-common.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/java-inner-loop-dev-guide">Java Inner Loop Dev Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
        <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="java-inner-loop-dev-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Java Inner-Loop Dev</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#preliminary-tests">Preliminary Tests</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02a-spring-boot-common.html">Spring Boot Inner-Loop</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02a-spring-boot-common.html">Using H2</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02a-spring-boot-common.html#the-code">The code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02a-spring-boot-common.html#maven-profiles">Maven Profiles</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02a-spring-boot-common.html#run-local">Running the code locally against H2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02b-spring-boot-deploy-postgresql.html">Using PostgreSQL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02b-spring-boot-deploy-postgresql.html#deploy-database">Deploying PostgreSQL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02b-spring-boot-deploy-postgresql.html#deploy-code">Deploying the code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02b-spring-boot-deploy-postgresql.html#run-local-telepresence">Extending the inner-loop with Telepresence</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02b-spring-boot-deploy-postgresql.html#binary-deploy">Binary deploy (S2I)</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02c-spring-boot-deploy-oracle.html">Using Oracle RBDMS</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deploy-database">Deploying Oracle</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deploy-code">Deploying the code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#run-local-telepresence">Extending the inner-loop with Telepresence</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#binary-deploy">Binary deploy (S2I)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03a-quarkus-common.html">Quarkus Inner-Loop</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03a-quarkus-common.html">Using H2</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03a-quarkus-common.html#the-code">The code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03a-quarkus-common.html#maven-profiles">Maven Profiles</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03a-quarkus-common.html#run-local">Running the code locally against H2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03b-quarkus-deploy-postgresql.html">PostgreSQL as Database</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03b-quarkus-deploy-postgresql.html#deploy-database">Deploying PostgreSQL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03b-quarkus-deploy-postgresql.html#deploy-code">Deploying the code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03b-quarkus-deploy-postgresql.html#run-local-telepresence">Extending the inner-loop with Telepresence</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03b-quarkus-deploy-postgresql.html#run-local-remote-dev">Extending the inner-loop with remote development</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03b-quarkus-deploy-postgresql.html#binary-deploy">Binary deploy (S2I)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03c-quarkus-deploy-oracle.html">Oracle as Database</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03c-quarkus-deploy-oracle.html#deploy-database">Deploying Oracle</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03c-quarkus-deploy-oracle.html#deploy-code">Deploying the code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03c-quarkus-deploy-oracle.html#run-local-telepresence">Extending the inner-loop with Telepresence</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03c-quarkus-deploy-oracle.html#run-local-remote-dev">Extending the inner-loop with remote development</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03c-quarkus-deploy-oracle.html#binary-deploy">Binary deploy (S2I)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Java Inner-Loop Dev</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Java Inner-Loop Dev</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Java Inner-Loop Dev</a></li>
    <li><a href="02a-spring-boot-common.html">Spring Boot Inner-Loop</a></li>
    <li><a href="02c-spring-boot-deploy-oracle.html">Using Oracle RBDMS</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/java-inner-loop-dev-guide/edit/master/documentation/modules/ROOT/pages/02c-spring-boot-deploy-oracle.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Oracle as Database</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This part of the lab is different compared to the previous one where we deployed PostgreSQL alongside the code. This time we’re going to install the database (Oracle) in a different namespace to make it look as an external database. The Oracle database is quite large, it takes a while to download and install. You will also need an account in <a href="https://container-registry.oracle.com/pls/apex/f?p=113:1:113820723533011:::1:P1_BUSINESS_AREA:3:" target="_blank" rel="noopener">Oracle Container Registry</a> to access it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t have an Oracle Account you can create one <a href="https://profile.oracle.com/myprofile/account/create-account.jspx" target="_blank" rel="noopener">here</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-database"><a class="anchor" href="#deploy-database"></a>Deploying Oracle on OpenShift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Please run these commands as cluster-admin to deploy Oracle DB:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The Oracle database image to be downloaded is quite big, so grab a cup of coffee and be patient.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="title">Create a project to deploy Oracle DB</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">export ORACLE_DB_PROJECT_NAME=oracle-db-prj
oc new-project ${ORACLE_DB_PROJECT_NAME}</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="title">Adjust permissions</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc adm policy add-scc-to-user privileged -z default -n ${ORACLE_DB_PROJECT_NAME} &amp;&amp; \
  oc adm policy add-scc-to-user anyuid -z default -n ${ORACLE_DB_PROJECT_NAME}</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="title">Type in your user/email in the Oracle Container Registry</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">echo -n "Reg. Email: " &amp;&amp; read email</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="title">Type in your password in the Oracle Container Registry</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">echo -n "Reg. Password: " &amp;&amp; read -s password</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="title">Create a pull secret for the Oracle Container Registry</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc create secret docker-registry oracle-registry \
  --docker-server=container-registry.oracle.com \
  --docker-username=${email} \
  --docker-password=${password} \
  --docker-email=${email} -n ${ORACLE_DB_PROJECT_NAME}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The next step may fail because of lack of resources, you may need to delete/adjust Limit Ranges in the target namespace because the deployment object will request 4Gi.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="title">Finally deploy Oracle DB</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc apply -f ./k8s/oracle-db.yaml -n ${ORACLE_DB_PROJECT_NAME}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once the container is running again be patient, after starting the DB daemon data needs to be copied, this could take more than 10 minutes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To check activity, use the logs:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc logs -f $(oc get pods -o json | jq -r '.items[] | select(.metadata.name | test("oracle-db")).metadata.name') -n ${ORACLE_DB_PROJECT_NAME}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you see this in the logs then you are progressing well:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">[2021:01:25 16:50:34]: Acquiring lock on /opt/oracle/oradata/.ORCL.create_lck
[2021:01:25 16:50:34]: Lock acquired on /opt/oracle/oradata/.ORCL.create_lck
[2021:01:25 16:50:34]: Holding on to the lock using /tmp/.ORCL.create_lck
ORACLE EDITION: ENTERPRISE
ORACLE PASSWORD FOR SYS, SYSTEM AND PDBADMIN: ******

LSNRCTL for Linux: Version 19.0.0.0.0 - Production on 25-JAN-2021 16:50:34

Copyright (c) 1991, 2019, Oracle.  All rights reserved.

Starting /opt/oracle/product/19c/dbhome_1/bin/tnslsnr: please wait...

TNSLSNR for Linux: Version 19.0.0.0.0 - Production
System parameter file is /opt/oracle/product/19c/dbhome_1/network/admin/listener.ora
Log messages written to /opt/oracle/diag/tnslsnr/oracle-db-5999c5bd66-x9t9h/listener/alert/log.xml
Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1)))
Listening on: (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=0.0.0.0)(PORT=1521)))

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1)))
STATUS of the LISTENER
------------------------
Alias                     LISTENER
Version                   TNSLSNR for Linux: Version 19.0.0.0.0 - Production
Start Date                25-JAN-2021 16:50:34
Uptime                    0 days 0 hr. 0 min. 0 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      OFF
Listener Parameter File   /opt/oracle/product/19c/dbhome_1/network/admin/listener.ora
Listener Log File         /opt/oracle/diag/tnslsnr/oracle-db-5999c5bd66-x9t9h/listener/alert/log.xml
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=0.0.0.0)(PORT=1521)))
The listener supports no services
The command completed successfully
Prepare for db operation
8% complete
Copying database files
31% complete
Creating and starting Oracle instance
32% complete
36% complete
40% complete
43% complete
46% complete
Completing Database Creation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now wait until the database has been initialized, you should see this.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">...

The Oracle base remains unchanged with value /opt/oracle
#########################
DATABASE IS READY TO USE!
#########################

Executing user defined scripts
/opt/oracle/runUserScripts.sh: ignoring /opt/oracle/scripts/startup/lost+found

DONE: Executing user defined scripts

The following output is now a tail of the alert.log:
ORCLPDB1(3):
ORCLPDB1(3):XDB initialized.
2021-01-25T17:05:21.301744+00:00
ALTER SYSTEM SET control_files='/opt/oracle/oradata/ORCL/control01.ctl' SCOPE=SPFILE;
2021-01-25T17:05:21.307239+00:00
ALTER SYSTEM SET local_listener='' SCOPE=BOTH;
   ALTER PLUGGABLE DATABASE ORCLPDB1 SAVE STATE
Completed:    ALTER PLUGGABLE DATABASE ORCLPDB1 SAVE STATE

XDB initialized.</code></pre>
</div>
</div>
<div class="paragraph">
<p>So the database has been initialized, now we have to create a user in PDB <code>ORCLPDB1</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s connect to the container and run some commands in order to create the user/schema to hold our data in PDB <code>ORCLPDB1</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc project ${ORACLE_DB_PROJECT_NAME}
oc rsh $(oc get pods -o json | jq -r '.items[] | select(.metadata.name | test("oracle-db")).metadata.name')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that you&#8217;re connected to the container run this command&#8230;&#8203;</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The prompt look like this &#8658; <code>sh-4.2$</code>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">sqlplus system/Kube#2020@localhost:1521/${ORACLE_PDB}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this should be the output you get.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">SQL*Plus: Release 19.0.0.0.0 - Production on Mon Jan 25 17:10:36 2021
Version 19.3.0.0.0

Copyright (c) 1982, 2019, Oracle.  All rights reserved.


Connected to:
Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
Version 19.3.0.0.0

SQL&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run these SQL statements in <code>sqlplus</code>:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Prompt shoud look like this &#8658; <code>SQL&gt;</code>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">create user luke identified by "secret";</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this is what you should get.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">User created.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s grant the user with the required permissions:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">grant CREATE SESSION, ALTER SESSION, CREATE DATABASE LINK, -
  CREATE MATERIALIZED VIEW, CREATE PROCEDURE, CREATE PUBLIC SYNONYM, -
  CREATE ROLE, CREATE SEQUENCE, CREATE SYNONYM, CREATE TABLE, -
  CREATE TRIGGER, CREATE TYPE, CREATE VIEW, UNLIMITED TABLESPACE -
  to luke;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the expected output.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">Grant succeeded.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice! You&#8217;re Oracle DB is up and running, initialized and the DB Schema has been created. You can exit <code>sqplplus</code> and the container.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-code"><a class="anchor" href="#deploy-code"></a>Deploying the code on OpenShift</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Now resume as a normal user, no need to be <code>cluster-admin</code> anymore.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to run our application, we need a namespace, let&#8217;s create one:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">export PROJECT_NAME=%USERNAME%-fruit-service-oracle
oc new-project ${PROJECT_NAME}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="define-external-service"><a class="anchor" href="#define-external-service"></a>Define the database service as external</h3>
<div class="paragraph">
<p>We want to connect to the Oracle DB as if it were external, so let&#8217;s create a <code>Service</code> using a external name:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -n ${PROJECT_NAME} -f -
apiVersion: v1
kind: Service
metadata:
  name: oracle-db
spec:
  type: ExternalName
  externalName: oracle-db.oracle-db-prj.svc.cluster.local
EOF</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is not the only way, you could create a service with no selector and point to an external but reachable IP address, as in this example. We cannot use this approach because the IP of our Oracle DB is internal and this is not allowed. Here you are an example.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">kind: Service
apiVersion: v1
metadata:
 name: oracle-db
spec:
 type: ClusterIP
 ports:
 - port: 1521
   targetPort: 1521
---
kind: Endpoints
apiVersion: v1
metadata:
 name: oracle-db
subsets:
 - addresses:
     - ip: ${ORACLE_DB_SVC_IP}
   ports:
     - port: 1521
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, time to deploy our oracle-flavoured application, please execute these commands:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc project ${PROJECT_NAME}
mvn clean oc:deploy -Popenshift-oracle -DskipTests</code></pre>
</div>
</div>
<div class="paragraph">
<p>Have a look to the expected output.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[INFO] Scanning for projects...
...
[INFO]
[INFO] -----------------&lt; dev.snowdrop.example:fruit-service &gt;-----------------
[INFO] Building Spring Boot - CRUD Example 1.0.0
[INFO] --------------------------------[ jar ]---------------------------------
...
[INFO] Copying 7 resources
[INFO] Copying 1 resource to static
[INFO]
[INFO] --- openshift-maven-plugin:1.1.0:resource (fmp) @ fruit-service ---
[INFO] oc: Using docker image name of namespace: {artifact_id}-dev
[INFO] oc: Running generator spring-boot
[INFO] oc: spring-boot: Using Docker image quay.io/jkube/jkube-java-binary-s2i:0.0.9 as base / builder
[INFO] oc: Using resource templates from /Users/cvicensa/Projects/openshift/redhat-scholars/java-inner-loop-dev-guide/src/main/jkube
[INFO] oc: jkube-healthcheck-spring-boot: Adding readiness probe on port 8080, path='/actuator/health', scheme='HTTP', with initial delay 10 seconds
[INFO] oc: jkube-healthcheck-spring-boot: Adding liveness probe on port 8080, path='/actuator/health', scheme='HTTP', with initial delay 180 seconds
[INFO] oc: jkube-service-discovery: Using first mentioned service port '8080'
[INFO] oc: jkube-revision-history: Adding revision history limit to 2
[INFO]
...
[INFO] --- openshift-maven-plugin:1.1.0:build (fmp) @ fruit-service ---
[INFO] oc: Using OpenShift build with strategy S2I
[INFO] oc: Running in OpenShift mode
[INFO] oc: Running generator spring-boot
[INFO] oc: spring-boot: Using Docker image quay.io/jkube/jkube-java-binary-s2i:0.0.9 as base / builder
[INFO] oc: [fruit-service:1.0.0] "spring-boot": Created docker source tar /Users/cvicensa/Projects/openshift/redhat-scholars/java-inner-loop-dev-guide/target/docker/fruit-service/1.0.0/tmp/docker-build.tar
[INFO] oc: Creating Secret
[INFO] oc: Updating BuildServiceConfig fruit-service-s2i for Source strategy
[INFO] oc: Adding to ImageStream fruit-service
[INFO] oc: Starting Build fruit-service-s2i
[INFO] oc: Waiting for build fruit-service-s2i-5 to complete...
[INFO] oc: Caching blobs under "/var/cache/blobs".
[INFO] oc: Getting image source signatures
[INFO] oc: Copying blob sha256:a6b97b4963f5ace479dbf5bdc821bdb757de2aef502a39a19b236856827250d0
[INFO] oc: Copying blob sha256:13948a011eecd34fe31551e2e072246169350e27314e5f84b94508c0f848ae7e
[INFO] oc: Copying blob sha256:ccd8aed47e111ef230e879b3773d55df509f7ee7f329d0bb131190d7493f04ba
[INFO] oc: Copying config sha256:910caf82544b3f0254b67200c1a1e441631884d530a6d292e9fef1216ef66051
[INFO] oc: Writing manifest to image destination
[INFO] oc: Storing signatures
[INFO] oc: Generating dockerfile with builder image quay.io/jkube/jkube-java-binary-s2i:0.0.9
[INFO] oc: STEP 1: FROM quay.io/jkube/jkube-java-binary-s2i:0.0.9
...
[INFO] oc: INFO S2I source build with plain binaries detected
[INFO] oc: INFO S2I binary build from fabric8-maven-plugin detected
[INFO] oc: INFO Copying binaries from /tmp/src/deployments to /deployments ...
[INFO] oc: fruit-service-1.0.0.jar
[INFO] oc: INFO Copying deployments from deployments to /deployments...
[INFO] oc: '/tmp/src/deployments/fruit-service-1.0.0.jar' -&gt; '/deployments/fruit-service-1.0.0.jar'
[INFO] oc: INFO Cleaning up source directory (/tmp/src)
[INFO] oc: STEP 9: CMD /usr/local/s2i/run
[INFO] oc: STEP 10: COMMIT temp.builder.openshift.io/{artifact_id}-dev/fruit-service-s2i-5:d7248b5b
...
[INFO] oc:
[INFO] oc: Pushing image image-registry.openshift-image-registry.svc:5000/{artifact_id}-dev/fruit-service:1.0.0 ...
...
[INFO] oc: Successfully pushed image-registry.openshift-image-registry.svc:5000/{artifact_id}-dev/fruit-service@sha256:8e12d974c41953f19f6a769bde8dc19898aabce7038025d442de825c7102b7b1
[INFO] oc: Push successful
...
[INFO] &lt;&lt;&lt; openshift-maven-plugin:1.1.0:deploy (default-cli) &lt; install @ fruit-service &lt;&lt;&lt;
[INFO]
[INFO]
[INFO] --- openshift-maven-plugin:1.1.0:deploy (default-cli) @ fruit-service ---
[INFO] oc: Using OpenShift at https://api.cluster-2036.2036.example.opentlc.com:6443/ in namespace {artifact_id}-dev with manifest /Users/cvicensa/Projects/openshift/redhat-scholars/java-inner-loop-dev-guide/target/classes/META-INF/jkube/openshift.yml
[INFO] oc: OpenShift platform detected
[INFO] oc: Using project: {artifact_id}-dev
[INFO] oc: Creating a Secret from openshift.yml namespace {artifact_id}-dev name fruit-service-postgresql-db
[INFO] oc: Created Secret: target/jkube/applyJson/{artifact_id}-dev/secret-fruit-service-postgresql-db.json
[INFO] oc: Updating Service from openshift.yml
[INFO] oc: Updated Service: target/jkube/applyJson/{artifact_id}-dev/service-fruit-service.json
[INFO] oc: Creating a ConfigMap from openshift.yml namespace {artifact_id}-dev name fruit-service-postgresql-configmap
[INFO] oc: Created ConfigMap: target/jkube/applyJson/{artifact_id}-dev/configmap-fruit-service-postgresql-configmap.json
[INFO] oc: Creating a DeploymentConfig from openshift.yml namespace {artifact_id}-dev name fruit-service
[INFO] oc: Created DeploymentConfig: target/jkube/applyJson/{artifact_id}-dev/deploymentconfig-fruit-service.json
[INFO] oc: Updating Route from openshift.yml
[INFO] oc: Updated Route: target/jkube/applyJson/{artifact_id}-dev/route-fruit-service.json
[INFO] oc: HINT: Use the command `oc get pods -w` to watch your pods start up
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  01:25 min
[INFO] Finished at: 2021-02-01T08:32:17+01:00
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>Move to the OpenShift web console and from <code>Topology</code> in the <code>Developer</code> perspective click on the route link as in the picture.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/fruit-service-oracle-topology.png" alt="Fruit Service on Oracle Topology">
</div>
</div>
<div class="paragraph">
<p>You should see this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/fruit-service-oracle-display.png" alt="Fruit Service on Oracle Topology">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run-local-telepresence"><a class="anchor" href="#run-local-telepresence"></a>Extending the inner-loop with Telepresence</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Permissions needed</div>
<div class="paragraph">
<p>This needs to be run by a <code>cluster-admin</code></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc adm policy add-scc-to-user privileged -z default -n ${PROJECT_NAME} &amp;&amp; \
oc adm policy add-scc-to-user anyuid -z default -n ${PROJECT_NAME}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Telepresence will modify the network so that Services in Kubernetes are reachable from your laptop and vice versa.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next command will result in the deployment for our application being scaled down to zero and the network altered so that traffic to it ends up in your laptop in port <code>8080</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/fruit-service-oracle-topology-telepresence.png" alt="Fruit Service on Oracle Topology - Spring Boot with Telepresence">
</div>
<div class="title">Figure 1. Deployment scaled down to zero while using Telepresence</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You&#8217;ll be asked for <code>sudo</code> password, this is normal, telepresence needs to be able to modify networking rules so that you can see Kubernetes Services as local.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">export TELEPRESENCE_USE_OCP_IMAGE=NO
oc project ${PROJECT_NAME}
telepresence --swap-deployment fruit-service --expose 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Evetually you&#8217;ll se something like this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">...
T: Forwarding remote port 9779 to local port 9779.
T: Forwarding remote port 8080 to local port 8080.
T: Forwarding remote port 8778 to local port 8778.

T: Guessing that Services IP range is ['172.30.0.0/16']. Services started after this point will be inaccessible if are outside this range; restart telepresence
T: if you can't access a new Service.
T: Connected. Flushing DNS cache.
T: Setup complete. Launching your command.

The default interactive shell is now zsh.
To update your account to use zsh, please run `chsh -s /bin/zsh`.
For more details, please visit https://support.apple.com/kb/HT208050.
@fruit-service-oracle-dev/api-cluster-5555-5555-acme-com:6443/user1|bash-3.2$</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Run from another terminal:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">curl http://oracle-db:1521</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should receive which looks bad but it&#8217;s actually good, this means that the DNS Service name local to Kubernetes can be resolved from your computer and that the port <code>1521</code> has been reached!</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">curl: (52) Empty reply from server`</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now from another terminal:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">export PROJECT_NAME=%USERNAME%-fruit-service-oracle
SERVICE_DB_USER=luke SERVICE_DB_PASSWORD=secret SERVICE_DB_NAME=FRUITSDB SERVICE_DB_HOST=oracle-db \
  mvn clean spring-boot:run -Dspring-boot.run.profiles=openshift-oracle -Popenshift-oracle</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now open a browser and point to <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can edit, save, delete to test the functionalities implemented by <code>FruitController</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You should see this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/fruit-service-oracle-display.png" alt="Fruit Service on PostgreSQL">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="binary-deploy"><a class="anchor" href="#binary-deploy"></a>Binary deploy S2I</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, imagine that after debugging your code locally you want to redeploy on OpenShift in a similar way but without using the JKube extension. This is possible because JKube is leveraging Source to Image (S2I) let&#8217;s have a look to the <code>BuildConfigs</code> in our project.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do this.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc get bc -n ${PROJECT_NAME}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should get this.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">NAME                TYPE     FROM     LATEST
fruit-service-s2i   Source   Binary   2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s read some details:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc get bc/fruit-service-s2i -o yaml -n ${PROJECT_NAME}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should get this. We have deleted transient or obvious data to focus on the important part of the YAML.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Focus on <code>spec&#8594;source&#8594;type</code> &#8658; <code>Binary</code> this means that in order to build image <code>spec&#8594;output&#8594;to&#8594;name</code> you need to provide a binary file, a <code>JAR</code> file in this case.
</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  labels:
    app: fruit-service
    group: dev.snowdrop.example
    provider: jkube
    version: 1.0.0
  name: fruit-service-s2i
  namespace: fruit-service-oracle-dev
  ...
spec:
  failedBuildsHistoryLimit: 5
  nodeSelector: null
  output:
    to:
      kind: ImageStreamTag
      name: fruit-service:1.0.0
  postCommit: {}
  resources: {}
  runPolicy: Serial
  source:
    binary: {}
    type: Binary
  strategy:
    sourceStrategy:
      from:
        kind: DockerImage
        name: registry.access.redhat.com/redhat-openjdk-18/openjdk18-openshift:latest
    type: Source
  successfulBuildsHistoryLimit: 5
status:
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s package our application with the right profile and build an image with it:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">mvn clean package -Popenshift-oracle</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a successful build, let&#8217;s start the build of the image in OpenShift:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc start-build fruit-service-s2i --from-file=./target/fruit-service-1.0.0.jar -n ${PROJECT_NAME}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the output the <code>JAR</code> file is uploaded and a new Build is started.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">Uploading file "target/fruit-service-1.0.0.jar" as binary input for the build ...
...
Uploading finished
build.build.openshift.io/fruit-service-s2i-3 started</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s have a look to the logs while the build is happening:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">oc logs -f bc/fruit-service-s2i -n ${PROJECT_NAME}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Log output from the current build (only relevant lines):</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It all starts with <code>Receiving source from STDIN as file fruit-service-1.0.0.jar</code> so the image is built from a binary file within OpenShift as we checked out before.
</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">Receiving source from STDIN as file fruit-service-1.0.0.jar
Caching blobs under "/var/cache/blobs".
Getting image source signatures
...
Writing manifest to image destination
Storing signatures
Generating dockerfile with builder image registry.access.redhat.com/redhat-openjdk-18/openjdk18-openshift:latest
STEP 1: FROM registry.access.redhat.com/redhat-openjdk-18/openjdk18-openshift:latest
STEP 2: LABEL "io.openshift.build.source-location"="/tmp/build/inputs"       "io.openshift.s2i.destination"="/tmp"       "io.openshift.build.image"="registry.access.redhat.com/redhat-openjdk-18/openjdk18-openshift:latest"
STEP 3: ENV OPENSHIFT_BUILD_NAME="fruit-service-s2i-3"     OPENSHIFT_BUILD_NAMESPACE="fruit-service-postgresql-dev"
STEP 4: USER root
STEP 5: COPY upload/src /tmp/src
STEP 6: RUN chown -R 185:0 /tmp/src
STEP 7: USER 185
STEP 8: RUN /usr/local/s2i/assemble
INFO S2I source build with plain binaries detected
INFO Copying binaries from /tmp/src to /deployments ...
fruit-service-1.0.0.jar
STEP 9: CMD /usr/local/s2i/run
STEP 10: COMMIT temp.builder.openshift.io/fruit-service-postgresql-dev/fruit-service-s2i-3:5b6ab412
Getting image source signatures
...
Writing manifest to image destination
Storing signatures
--&gt; 56ea06fd4ac
56ea06fd4ac030f9d3356a917c6a31aaa791d6fff000852a4e87eedbf06432ad

Pushing image image-registry.openshift-image-registry.svc:5000/fruit-service-postgresql-dev/fruit-service:1.0.0 ...
Getting image source signatures
...
Successfully pushed image-registry.openshift-image-registry.svc:5000/fruit-service-postgresql-dev/fruit-service@sha256:ae0a508200be22c45f3af7d5cd7f7ad32351f480f50b15bc9ad71b76fb37fa54
Push successful</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02b-spring-boot-deploy-postgresql.html" class="query-params-link">Using PostgreSQL</a></span>
  <span class="next"><a href="03a-quarkus-common.html" class="query-params-link">Quarkus Inner-Loop</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
